package kernel

import (
	"fmt"
	"loiter/backstage"
	"loiter/config"
	"loiter/global"
	"loiter/kernel/container"
	"loiter/kernel/initializer"
	"loiter/kernel/proxy"
	"loiter/plugin"
	"net/http"
)

/**
 * 网关启动器
 * @author eyesYeager
 * @date 2023/9/25 16:50
 */

// Start 启动网关服务
func Start() {
	// 注册插件
	plugin.Register()

	// 初始化数据库数据
	initializer.InitData()

	// 注册容器信息
	container.InitRegister()

	// 执行代理配置
	proxy.StartProxy()

	// 启动后台web服务
	go backstage.Start()

	// 打印启动横幅
	printBanner()

	// 启动网关服务
	global.AppLogger.Info("start running gateway service, service port:", config.Program.GateWayPort)
	if err := http.ListenAndServe(":"+config.Program.GateWayPort, nil); err != nil {
		panic(fmt.Errorf("failed to execute http.ListenAndServe(:%s): %s", config.Program.GateWayPort, err))
	}
}

// printBanner 打印启动横幅
func printBanner() {
	bannerWord := "\n" +
		"          _____           _______                   _____                _____                    _____                    _____          \n" +
		"         /\\    \\         /::\\    \\                 /\\    \\              /\\    \\                  /\\    \\                  /\\    \\         \n" +
		"        /::\\____\\       /::::\\    \\               /::\\    \\            /::\\    \\                /::\\    \\                /::\\    \\        \n" +
		"       /:::/    /      /::::::\\    \\              \\:::\\    \\           \\:::\\    \\              /::::\\    \\              /::::\\    \\       \n" +
		"      /:::/    /      /::::::::\\    \\              \\:::\\    \\           \\:::\\    \\            /::::::\\    \\            /::::::\\    \\      \n" +
		"     /:::/    /      /:::/~~\\:::\\    \\              \\:::\\    \\           \\:::\\    \\          /:::/\\:::\\    \\          /:::/\\:::\\    \\     \n" +
		"    /:::/    /      /:::/    \\:::\\    \\              \\:::\\    \\           \\:::\\    \\        /:::/__\\:::\\    \\        /:::/__\\:::\\    \\    \n" +
		"   /:::/    /      /:::/    / \\:::\\    \\             /::::\\    \\          /::::\\    \\      /::::\\   \\:::\\    \\      /::::\\   \\:::\\    \\   \n" +
		"  /:::/    /      /:::/____/   \\:::\\____\\   ____    /::::::\\    \\        /::::::\\    \\    /::::::\\   \\:::\\    \\    /::::::\\   \\:::\\    \\  \n" +
		" /:::/    /      |:::|    |     |:::|    | /\\   \\  /:::/\\:::\\    \\      /:::/\\:::\\    \\  /:::/\\:::\\   \\:::\\    \\  /:::/\\:::\\   \\:::\\____\\ \n" +
		"/:::/____/       |:::|____|     |:::|    |/::\\   \\/:::/  \\:::\\____\\    /:::/  \\:::\\____\\/:::/__\\:::\\   \\:::\\____\\/:::/  \\:::\\   \\:::|    |\n" +
		"\\:::\\    \\        \\:::\\    \\   /:::/    / \\:::\\  /:::/    \\::/    /   /:::/    \\::/    /\\:::\\   \\:::\\   \\::/    /\\::/   |::::\\  /:::|____|\n" +
		" \\:::\\    \\        \\:::\\    \\ /:::/    /   \\:::\\/:::/    / \\/____/   /:::/    / \\/____/  \\:::\\   \\:::\\   \\/____/  \\/____|:::::\\/:::/    / \n" +
		"  \\:::\\    \\        \\:::\\    /:::/    /     \\::::::/    /           /:::/    /            \\:::\\   \\:::\\    \\            |:::::::::/    /  \n" +
		"   \\:::\\    \\        \\:::\\__/:::/    /       \\::::/____/           /:::/    /              \\:::\\   \\:::\\____\\           |::|\\::::/    /   \n" +
		"    \\:::\\    \\        \\::::::::/    /         \\:::\\    \\           \\::/    /                \\:::\\   \\::/    /           |::| \\::/____/    \n" +
		"     \\:::\\    \\        \\::::::/    /           \\:::\\    \\           \\/____/                  \\:::\\   \\/____/            |::|  ~|          \n" +
		"      \\:::\\    \\        \\::::/    /             \\:::\\    \\                                    \\:::\\    \\                |::|   |          \n" +
		"       \\:::\\____\\        \\::/____/               \\:::\\____\\                                    \\:::\\____\\               \\::|   |          \n" +
		"        \\::/    /         ~~                      \\::/    /                                     \\::/    /                \\:|   |          \n" +
		"         \\/____/                                   \\/____/                                       \\/____/                  \\|___|          \n"

	print(bannerWord)
}
